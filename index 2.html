<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Email Draft Exporter</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#fafafa; color:#111; }
    .wrap { max-width: 820px; margin: 28px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin: 0 0 14px; }
    .card { background:#fff; border:1px solid #e5e5e5; border-radius: 14px; padding: 14px; margin: 12px 0; }
    label { display:block; font-size: 13px; opacity: .8; margin: 10px 0 6px; }
    input, textarea, select { width: 100%; border:1px solid #ddd; border-radius: 10px; padding: 10px; font-size: 16px; }
    textarea { min-height: 130px; resize: vertical; }
    button { border:1px solid #111; background:#fff; border-radius: 12px; padding: 12px 14px; font-size: 16px; font-weight: 650; cursor: pointer; }
    button:disabled { opacity: .45; cursor: not-allowed; }
    .meta { font-size: 13px; opacity: .75; line-height: 1.4; margin-top: 10px; }
    .instructions { background:#f0f8ff; border:1px solid #cce5ff; }
    .step { margin-bottom:10px; }
    .mono { font-family: monospace; background:#f5f5f5; padding:2px 6px; border-radius:6px; }
    .good { color: #0a7a2f; }
    .bad { color: #b00020; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Email Draft Exporter</h1>

    <div class="card instructions">
      <h2>How To Use This (Super Simple)</h2>
      <div class="step"><strong>Step 1:</strong> Make an Excel file with a column named <span class="mono">email</span>.</div>
      <div class="step"><strong>Step 2:</strong> Upload the Excel file below.</div>
      <div class="step"><strong>Step 3:</strong> Type your message.</div>
      <div class="step"><strong>Step 4:</strong> Click <strong>Export Drafts</strong>.</div>
      <div class="step">This tool does NOT send emails. It only creates drafts.</div>
    </div>

    <div class="card">
      <label>Upload Excel (.xlsx)</label>
      <input id="file" type="file" accept=".xlsx,.xls" />
      <div class="meta" id="fileMeta">No file loaded.</div>
    </div>

    <div class="card">
      <label>Recipient Name (optional fallback)</label>
      <input id="fallbackName" placeholder="Example: Tom" />

      <label>Subject</label>
      <input id="subject" value="Quick note" />

      <label>Message</label>
      <textarea id="message" placeholder="Type your message here..."></textarea>
    </div>

    <div class="card">
      <button id="exportBtn" disabled>Export Drafts</button>
      <div class="meta" id="exportMeta"></div>
    </div>
  </div>

  <!-- Stable XLSX source -->
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    const fileEl = document.getElementById('file');
    const exportBtn = document.getElementById('exportBtn');
    const exportMetaEl = document.getElementById('exportMeta');
    const fallbackNameEl = document.getElementById('fallbackName');
    const subjectEl = document.getElementById('subject');
    const messageEl = document.getElementById('message');

    let rows = [];

    function isLikelyEmail(v) {
      const s = String(v || '').trim();
      return s.includes('@') && s.includes('.') && s.length >= 6;
    }

    function buildEML({ toEmail, toName, subject, body }) {
      const CRLF = "\r\n";
      const date = new Date().toUTCString();
      const toHeader = toName ? `${toName} <${toEmail}>` : toEmail;

      return [
        `Date: ${date}`,
        `To: ${toHeader}`,
        `Subject: ${subject}`,
        `MIME-Version: 1.0`,
        `Content-Type: text/plain; charset="UTF-8"`,
        ``,
        body,
        ``
      ].join(CRLF);
    }

    function refreshUI() {
      exportBtn.disabled = !(rows.length > 0 && messageEl.value.trim().length > 0);
    }

    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        if (typeof XLSX === "undefined") {
          reject(new Error("Excel library failed to load. Refresh the page."));
          return;
        }

        const reader = new FileReader();

        reader.onerror = () => reject(new Error("Could not read the file."));

        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const sheetName = wb.SheetNames[0];
            const ws = wb.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(ws, { defval: '' });
            resolve(json);
          } catch (err) {
            reject(err);
          }
        };

        reader.readAsArrayBuffer(file);
      });
    }

    fileEl.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      try {
        document.getElementById('fileMeta').innerHTML = "Reading file...";
        rows = await readExcelFile(file);

        if (!rows.length) {
          document.getElementById('fileMeta').innerHTML = "No rows found.";
          refreshUI();
          return;
        }

        document.getElementById('fileMeta').innerHTML =
          `Loaded ${rows.length} rows.`;

        refreshUI();
      } catch (err) {
        rows = [];
        document.getElementById('fileMeta').innerHTML =
          "Import failed: " + (err.message || err);
        refreshUI();
      }
    });

    messageEl.addEventListener('input', refreshUI);

    exportBtn.addEventListener('click', async () => {
      const zip = new JSZip();
      let count = 0;

      rows.forEach((r, i) => {
        const toEmail = r.email;
        if (!isLikelyEmail(toEmail)) return;

        const eml = buildEML({
          toEmail,
          toName: fallbackNameEl.value.trim(),
          subject: subjectEl.value,
          body: messageEl.value
        });

        zip.file(`email_${i+1}.eml`, eml);
        count++;
      });

      if (!count) {
        exportMetaEl.innerHTML = "No valid emails found.";
        return;
      }

      const blob = await zip.generateAsync({ type: 'blob' });

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "email_drafts.zip";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      exportMetaEl.innerHTML = `Created ${count} drafts.`;
    });
  </script>
</body>
</html>
