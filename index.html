<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Email Draft Exporter</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#fafafa; color:#111; }
    .wrap { max-width: 820px; margin: 28px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin: 0 0 14px; }
    .card { background:#fff; border:1px solid #e5e5e5; border-radius: 14px; padding: 14px; margin: 12px 0; }
    label { display:block; font-size: 13px; opacity: .8; margin: 10px 0 6px; }
    input, textarea { width: 100%; border:1px solid #ddd; border-radius: 10px; padding: 10px; font-size: 16px; }
    textarea { min-height: 130px; resize: vertical; }
    button { border:1px solid #111; background:#fff; border-radius: 12px; padding: 12px 14px; font-size: 16px; font-weight: 650; cursor: pointer; }
    button:disabled { opacity: .45; cursor: not-allowed; }
    .meta { font-size: 13px; opacity: .75; line-height: 1.4; margin-top: 10px; }
    .instructions { background:#f0f8ff; border:1px solid #cce5ff; }
    .step { margin-bottom:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Email Draft Exporter</h1>

    <div class="card instructions">
      <h2>How To Use This (Super Simple)</h2>
      <div class="step"><strong>Step 1:</strong> Make an Excel file with a column named <strong>email</strong>.</div>
      <div class="step"><strong>Step 2:</strong> Upload the Excel file below.</div>
      <div class="step"><strong>Step 3:</strong> Type your message.</div>
      <div class="step"><strong>Step 4:</strong> Click <strong>Export Drafts</strong>.</div>
      <div class="step"><strong>Step 5:</strong> A ZIP file will download with one draft email for each person.</div>
      <div class="step">This tool does NOT send emails. It only creates drafts.</div>
    </div>

    <div class="card">
      <label>Upload Excel (.xlsx)</label>
      <input id="file" type="file" accept=".xlsx,.xls" />
      <div class="meta" id="fileMeta">No file loaded.</div>
    </div>

    <div class="card">
      <label>Recipient Name (optional)</label>
      <input id="fallbackName" placeholder="Example: Sarah" />
      <label>Subject</label>
      <input id="subject" value="Quick note" />
      <label>Message</label>
      <textarea id="message" placeholder="Type your message here..."></textarea>
    </div>

    <div class="card">
      <button id="exportBtn" disabled>Export Drafts</button>
      <div class="meta" id="exportMeta"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    const fileEl = document.getElementById('file');
    const exportBtn = document.getElementById('exportBtn');
    const exportMetaEl = document.getElementById('exportMeta');
    const fallbackNameEl = document.getElementById('fallbackName');
    const subjectEl = document.getElementById('subject');
    const messageEl = document.getElementById('message');

    let rows = [];

    function isLikelyEmail(v) {
      const s = String(v || '').trim();
      return s.includes('@') && s.includes('.');
    }

    function buildEML({ toEmail, toName, subject, body }) {
      const CRLF = "\r\n";
      const date = new Date().toUTCString();
      const toHeader = toName ? `${toName} <${toEmail}>` : toEmail;

      return [
        `Date: ${date}`,
        `To: ${toHeader}`,
        `Subject: ${subject}`,
        `MIME-Version: 1.0`,
        `Content-Type: text/plain; charset="UTF-8"`,
        ``,
        body,
        ``
      ].join(CRLF);
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function refreshUI() {
      exportBtn.disabled = !(rows.length > 0 && messageEl.value.trim().length > 0);
    }

    fileEl.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });

      document.getElementById('fileMeta').innerHTML = `Loaded ${rows.length} rows.`;
      refreshUI();
    });

    messageEl.addEventListener('input', refreshUI);

    exportBtn.addEventListener('click', async () => {
      const zip = new JSZip();
      let count = 0;

      rows.forEach((r, i) => {
        const toEmail = r.email;
        if (!isLikelyEmail(toEmail)) return;

        const toName = fallbackNameEl.value.trim();
        const eml = buildEML({
          toEmail,
          toName,
          subject: subjectEl.value,
          body: messageEl.value
        });

        zip.file(`email_${i+1}.eml`, eml);
        count++;
      });

      if (!count) {
        exportMetaEl.innerHTML = "No valid emails found.";
        return;
      }

      const blob = await zip.generateAsync({ type: 'blob' });
      downloadBlob(blob, `email_drafts.zip`);
      exportMetaEl.innerHTML = `Created ${count} drafts.`;
    });
  </script>
</body>
</html>
