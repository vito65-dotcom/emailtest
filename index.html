<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Email Draft Exporter</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#fafafa; color:#111; }
    .wrap { max-width: 820px; margin: 28px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin: 0 0 14px; }
    .card { background:#fff; border:1px solid #e5e5e5; border-radius: 14px; padding: 14px; margin: 12px 0; }
    label { display:block; font-size: 13px; opacity: .8; margin: 10px 0 6px; }
    input, textarea, select { width: 100%; border:1px solid #ddd; border-radius: 10px; padding: 10px; font-size: 16px; }
    textarea { min-height: 130px; resize: vertical; }
    .row { display:flex; gap: 12px; flex-wrap: wrap; }
    .row > div { flex: 1 1 240px; }
    button { border:1px solid #111; background:#fff; border-radius: 12px; padding: 12px 14px; font-size: 16px; font-weight: 650; cursor: pointer; }
    button:disabled { opacity: .45; cursor: not-allowed; }
    .meta { font-size: 13px; opacity: .75; line-height: 1.4; margin-top: 10px; }
    .instructions { background:#f0f8ff; border:1px solid #cce5ff; }
    .step { margin-bottom:10px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#f5f5f5; padding:2px 6px; border-radius:6px; }
    .good { color: #0a7a2f; }
    .bad { color: #b00020; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Email Draft Exporter</h1>

    <div class="card instructions">
      <h2 style="margin-top:0;">How To Use This (Super Simple)</h2>
      <div class="step"><strong>Step 1:</strong> Make an Excel file with a column named <span class="mono">email</span>.</div>
      <div class="step"><strong>Step 2:</strong> Upload the Excel file below.</div>
      <div class="step"><strong>Step 3:</strong> Type your message.</div>
      <div class="step"><strong>Step 4:</strong> Click <strong>Export Drafts</strong>.</div>
      <div class="step"><strong>Step 5:</strong> A ZIP file will download with one draft email for each person.</div>
      <div class="step">This tool does <strong>NOT</strong> send emails. It only creates drafts.</div>
    </div>

    <div class="card">
      <label>Upload Excel (.xlsx)</label>
      <input id="file" type="file" accept=".xlsx,.xls" />

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Email column</label>
          <select id="emailKey" disabled></select>
        </div>
        <div>
          <label>Name column (optional)</label>
          <select id="nameKey" disabled>
            <option value="">(none)</option>
          </select>
        </div>
      </div>

      <div class="meta" id="fileMeta">No file loaded.</div>
    </div>

    <div class="card">
      <label>Recipient Name (optional fallback)</label>
      <input id="fallbackName" placeholder="Example: Tom" />

      <label>Subject</label>
      <input id="subject" value="Quick note" />

      <label>Message</label>
      <textarea id="message" placeholder="Type your message here..."></textarea>
    </div>

    <div class="card">
      <button id="exportBtn" disabled>Export Drafts</button>
      <div class="meta" id="exportMeta"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    const fileEl = document.getElementById('file');
    const emailKeyEl = document.getElementById('emailKey');
    const nameKeyEl = document.getElementById('nameKey');
    const fileMetaEl = document.getElementById('fileMeta');
    const exportBtn = document.getElementById('exportBtn');
    const exportMetaEl = document.getElementById('exportMeta');

    const fallbackNameEl = document.getElementById('fallbackName');
    const subjectEl = document.getElementById('subject');
    const messageEl = document.getElementById('message');

    let rows = [];
    let headers = [];

    function normalizeHeader(h) {
      return String(h || '')
        .trim().toLowerCase()
        .replace(/\s+/g, '')
        .replace(/_/g, '');
    }

    function detectEmailKey(headers) {
      const normalized = headers.map(normalizeHeader);
      const candidates = ['email','emailaddress','e-mail','mail','to','address'];
      for (let i = 0; i < normalized.length; i++) {
        if (candidates.includes(normalized[i])) return headers[i];
      }
      return headers[0] || '';
    }

    function detectNameKey(headers) {
      const normalized = headers.map(normalizeHeader);
      const candidates = ['name','fullname','recipient','contact','firstname','lastname'];
      for (let i = 0; i < normalized.length; i++) {
        if (candidates.includes(normalized[i])) return headers[i];
      }
      return '';
    }

    function isLikelyEmail(v) {
      const s = String(v || '').trim();
      return s.includes('@') && s.includes('.') && s.length >= 6;
    }

    function buildEML({ toEmail, toName, subject, body }) {
      const CRLF = "\r\n";
      const date = new Date().toUTCString();
      const subj = String(subject || '').replace(/\r?\n/g, ' ').trim();
      const toHeader = toName ? `${toName} <${toEmail}>` : toEmail;

      return [
        `Date: ${date}`,
        `To: ${toHeader}`,
        `Subject: ${subj}`,
        `MIME-Version: 1.0`,
        `Content-Type: text/plain; charset="UTF-8"`,
        `Content-Transfer-Encoding: 8bit`,
        ``,
        String(body || ''),
        ``
      ].join(CRLF);
    }

    function refreshUI() {
      const ok = rows.length > 0 && messageEl.value.trim().length > 0 && emailKeyEl.value;
      exportBtn.disabled = !ok;
    }

    function populateSelects() {
      emailKeyEl.innerHTML = '';
      nameKeyEl.innerHTML = '<option value="">(none)</option>';

      headers.forEach(h => {
        const optE = document.createElement('option');
        optE.value = h;
        optE.textContent = h;
        emailKeyEl.appendChild(optE);

        const optN = document.createElement('option');
        optN.value = h;
        optN.textContent = h;
        nameKeyEl.appendChild(optN);
      });

      emailKeyEl.disabled = false;
      nameKeyEl.disabled = false;

      emailKeyEl.value = detectEmailKey(headers);
      nameKeyEl.value = detectNameKey(headers) || '';
    }

    // iOS-safe Excel read using FileReader (not file.arrayBuffer())
    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onerror = () => reject(new Error('Could not read the file.'));
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });
            const sheetName = wb.SheetNames[0];
            const ws = wb.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(ws, { defval: '' });
            resolve({ sheetName, json });
          } catch (err) {
            reject(err);
          }
        };

        reader.readAsArrayBuffer(file);
      });
    }

    fileEl.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      try {
        fileMetaEl.innerHTML = 'Reading file…';
        const { sheetName, json } = await readExcelFile(file);

        if (!json.length) {
          rows = [];
          headers = [];
          fileMetaEl.innerHTML = '<span class="bad">No rows found in the first sheet.</span>';
          emailKeyEl.disabled = true;
          nameKeyEl.disabled = true;
          refreshUI();
          return;
        }

        rows = json;
        headers = Object.keys(json[0] || {});
        populateSelects();

        const emailKey = emailKeyEl.value;
        const valid = rows.filter(r => isLikelyEmail(r[emailKey])).length;

        fileMetaEl.innerHTML =
          `Sheet: <b>${sheetName}</b><br>` +
          `Rows: <b>${rows.length}</b><br>` +
          `Valid emails found in “<span class="mono">${emailKey}</span>”: ` +
          `<b class="${valid ? 'good' : 'bad'}">${valid}</b>`;

        exportMetaEl.innerHTML = '';
        refreshUI();
      } catch (err) {
        rows = [];
        headers = [];
        fileMetaEl.innerHTML = `<span class="bad">Import failed:</span> ${err?.message || err}`;
        emailKeyEl.disabled = true;
        nameKeyEl.disabled = true;
        refreshUI();
      }
    });

    [emailKeyEl, nameKeyEl, messageEl].forEach(el => {
      el.addEventListener('change', refreshUI);
      el.addEventListener('input', refreshUI);
    });

    exportBtn.addEventListener('click', async () => {
      try {
        const emailKey = emailKeyEl.value;
        const nameKey = nameKeyEl.value;
        const fallbackName = fallbackNameEl.value.trim();
        const subject = subjectEl.value;
        const body = messageEl.value;

        const zip = new JSZip();
        let count = 0;

        rows.forEach((r, i) => {
          const toEmail = String(r[emailKey] || '').trim();
          if (!isLikelyEmail(toEmail)) return;

          const toName = (nameKey ? String(r[nameKey] || '').trim() : '') || fallbackName;

          const eml = buildEML({ toEmail, toName, subject, body });
          zip.file(`email_${String(i+1).padStart(3,'0')}.eml`, eml);
          count++;
        });

        if (!count) {
          exportMetaEl.innerHTML = '<span class="bad">No valid emails found to export.</span>';
          return;
        }

        exportMetaEl.innerHTML = `Building ZIP with <b>${count}</b> drafts…`;
        const blob = await zip.generateAsync({ type: 'blob' });

        // Download ZIP
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `email_drafts_${Date.now()}.zip`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        exportMetaEl.innerHTML = `Downloaded ZIP with <b>${count}</b> drafts.`;
      } catch (err) {
        exportMetaEl.innerHTML = `<span class="bad">Export failed:</span> ${err?.message || err}`;
      }
    });
  </script>
</body>
</html>
